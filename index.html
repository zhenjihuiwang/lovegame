<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat Phone</title>
    <link rel="stylesheet" href="style.css">
    <!-- 引入 localForage 库 (用于无限存储) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <!-- 引入图标库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

    <div class="phone-frame">
        <div id="notification-area"></div>

        <!-- 状态栏 (已添加ID) -->
        <div class="status-bar">
            <span id="status-time">00:00</span>
            <div class="icons">
                <!-- 信号图标保持静态，因为Web无法获取真实信号强度 -->
                <i class="fas fa-signal"></i>
                <!-- Wifi图标，稍后用JS判断是否有网 -->
                <i class="fas fa-wifi" id="status-wifi"></i>
                <!-- 电量图标和文字 -->
                <span id="battery-level" style="margin-right: 5px; font-size: 10px;"></span>
                <i class="fas fa-battery-full" id="status-battery"></i>
            </div>
        </div>
        
        <!-- 1. 手机主屏幕 -->
        <div id="screen-home" class="screen active">
            <div class="app-grid">
                <div class="app-icon" onclick="goToScreen('screen-friends')">
                    <div class="icon-img qq-style"><i class="fab fa-qq"></i></div>
                    <span>QQ</span>
                </div>
                <div class="app-icon" onclick="goToScreen('screen-settings-menu')">
                    <div class="icon-img settings-style"><i class="fas fa-tools"></i></div>
                    <span>系统设置</span>
                </div>
                <div class="app-icon" onclick="goToScreen('screen-themes')">
                    <div class="icon-img theme-style"><i class="fas fa-tshirt"></i></div>
                    <span>主题商店</span>
                </div>
            </div>
        </div>

        <!-- === 新增：系统设置主菜单 === -->
<div id="screen-settings-menu" class="screen">
    <div class="header">
        <button class="back-btn" onclick="goToScreen('screen-home')"><i class="fas fa-chevron-left"></i></button>
        <h3>系统设置</h3>
    </div>
    <div class="content padding">
        <div class="setting-menu-list">
            <!-- 跳转到原有的 API 设置页 -->
            <div class="menu-item" onclick="goToScreen('screen-settings')">
                <div class="menu-icon" style="background: #a18cd1;"><i class="fas fa-network-wired"></i></div>
                <div class="menu-text">
                    <h4>API 连接设置</h4>
                    <p>配置模型地址与密钥</p>
                </div>
                <i class="fas fa-chevron-right arrow"></i>
            </div>

            <!-- 跳转到新的 声音设置页 -->
            <div class="menu-item" onclick="goToScreen('screen-settings-sound')">
                <div class="menu-icon" style="background: #ff9a9e;"><i class="fas fa-music"></i></div>
                <div class="menu-text">
                    <h4>声音与振动</h4>
                    <p>通知音、气泡音、铃声</p>
                </div>
                <i class="fas fa-chevron-right arrow"></i>
            </div>
        </div>
    </div>
</div>

<!-- === 新增：声音设置界面 === -->
<div id="screen-settings-sound" class="screen">
    <div class="header">
        <button class="back-btn" onclick="goToScreen('screen-settings-menu')"><i class="fas fa-chevron-left"></i></button>
        <h3>声音设置</h3>
    </div>
    <div class="content padding scrollable">
        
        <!-- 0. 全局音量调节 -->
        <div class="setting-section" style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h4>🔊 系统音量</h4>
                <span id="vol-display-text" style="color:#4facfe; font-weight:bold;">50%</span>
            </div>
            <!-- 音量滑块 -->
            <input type="range" id="global-volume-slider" min="0" max="1" step="0.1" value="0.5" style="width:100%;" oninput="updateVolumePreview(this.value)" onchange="saveVolumeSetting()">
        </div>

        <p style="font-size:12px; color:#999; margin-bottom:15px; text-align:center;">
            * 系统不再提供默认声音，请手动上传音频文件 *
        </p>

        <!-- 1. 通知提示音 -->
        <div class="setting-section sound-upload-card">
            <div class="sound-info">
                <h4>🔔 通知提示音</h4>
                <p id="status-text-notif" style="font-size:12px; color:#ccc;">(未设置，静音)</p>
            </div>
            <button class="small-btn upload-btn" onclick="triggerSoundUpload('notif')">
                <i class="fas fa-upload"></i> 上传
            </button>
            <input type="file" id="file-notif" accept="audio/*" style="display:none" onchange="handleSoundUpload('notif', this)">
        </div>

        <!-- 2. 聊天气泡音 -->
        <div class="setting-section sound-upload-card">
            <div class="sound-info">
                <h4>💬 聊天气泡音</h4>
                <p id="status-text-chat" style="font-size:12px; color:#ccc;">(未设置，静音)</p>
            </div>
            <button class="small-btn upload-btn" onclick="triggerSoundUpload('chat')">
                <i class="fas fa-upload"></i> 上传
            </button>
            <input type="file" id="file-chat" accept="audio/*" style="display:none" onchange="handleSoundUpload('chat', this)">
        </div>

        <!-- 3. 来电铃声 -->
        <div class="setting-section sound-upload-card">
            <div class="sound-info">
                <h4>📞 视频/电话铃声</h4>
                <p id="status-text-ring" style="font-size:12px; color:#ccc;">(未设置，静音)</p>
            </div>
            <button class="small-btn upload-btn" onclick="triggerSoundUpload('ring')">
                <i class="fas fa-upload"></i> 上传
            </button>
            <input type="file" id="file-ring" accept="audio/*" style="display:none" onchange="handleSoundUpload('ring', this)">
        </div>

        <hr style="margin-top:20px; border:0; border-top:1px solid #eee;">
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="primary-btn" style="background-color: #ff4757; width: auto; padding: 10px 30px;" onclick="clearAllSounds()">
                <i class="fas fa-trash"></i> 清空所有声音
            </button>
        </div>
    </div>
</div>

        <!-- 2. API 设置界面 -->
        <div id="screen-settings" class="screen">
            <div class="header">
                <button class="back-btn" onclick="goToScreen('screen-settings-menu')"><i class="fas fa-chevron-left"></i></button>
                <h3>API与数据</h3>
            </div>
            <div class="content padding">
                <!-- 原有的 API 输入框保持不变 -->
                <div class="input-group">
                    <label>API 地址 (URL)</label>
                    <input type="text" id="api-url" placeholder="例如 https://api.openai.com/v1">
                </div>
                <div class="input-group">
                    <label>API 密钥 (Key)</label>
                    <input type="text" id="api-key" placeholder="sk-...">
                </div>
                <div class="input-group">
                    <label>模型选择 (Model)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="api-model" style="flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: white;">
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        </select>
                        <button class="check-btn" onclick="fetchModels()" style="width: auto; padding: 10px 15px; background-color: #4facfe; color: white; border: none; border-radius: 10px;">
                            <i class="fas fa-sync-alt"></i> 拉取
                        </button>
                    </div>
                </div>
                <button class="primary-btn" onclick="saveApiSettings()">保存配置</button>
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

                <!-- === 新增：全局世界控制 === -->
                <h4 style="margin-bottom: 10px; color: #666;"><i class="fas fa-globe"></i> 虚拟世界控制</h4>
                <div class="setting-item" style="background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid #eee;">
    
                    <div>
                        <strong style="display:block; color:#333;">允许角色自由活动</strong>
                        <small style="color:#999;">关闭后，所有角色将停止主动找你或评论</small>
                    </div>

                    <label class="toggle-switch">
                        <input type="checkbox" id="global-world-toggle" checked onchange="toggleWorldActivity()">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- ↓↓↓ 新增：手动唤醒按钮 ↓↓↓ -->
                <div class="setting-item" style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="display:block; color:#333;">手动唤醒世界</strong>
                            <small style="color:#999;">如果感觉AI睡着了，点这里强制检查一次</small>
                        </div>
                        <button class="primary-btn" onclick="forceHeartbeat()" style="width: auto; padding: 8px 20px; margin-top: 0; background: #a18cd1;">
                            <i class="fas fa-magic"></i> 戳一下
                        </button>
                        <button class="primary-btn" onclick="showIncomingCallScreen('测试：我想见你')" style="background: #ff3b30; margin-top: 10px;">
                            <i class="fas fa-phone"></i> 强制测试来电
                        </button>
                    </div>
                </div>
                
<hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

                <!-- === 新增：数据备份与恢复区域 === -->
                <h4 style="margin-bottom: 10px; color: #666;">💾 数据备份 (防丢失)</h4>
                <div style="display: flex; gap: 10px;">
                    <button class="primary-btn" onclick="exportData()" style="background-color: #28a745; margin-top:0;">
                        <i class="fas fa-download"></i> 导出备份
                    </button>
                    <button class="primary-btn" onclick="triggerImport()" style="background-color: #ffc107; color: #333; margin-top:0;">
                        <i class="fas fa-upload"></i> 恢复备份
                    </button>
                </div>
                <small style="color: #999; display: block; margin-top: 5px;">
                    如果是直接运行html文件，建议每次聊完天都点一下"导出备份"，文件会保存在你的电脑里。
                </small>
                
                <!-- 隐藏的文件上传控件 -->
                <input type="file" id="import-file" style="display: none;" onchange="importData(this)">
                <!-- ============================== -->

            </div>
        </div>
        <!-- 2.5 主题选择界面 (新增) -->
        <div id="screen-themes" class="screen">
            <div class="header">
                <button class="back-btn" onclick="goToScreen('screen-home')"><i class="fas fa-chevron-left"></i></button>
                <h3>主题商店</h3>
            </div>
            <div class="content padding" style="background: var(--bg-color);">
                <div class="theme-card" onclick="switchTheme('theme-candy')">
                    <div class="theme-preview preview-candy"></div>
                    <div class="theme-info">
                        <h4>🍬 棉花糖 (Candy)</h4>
                        <p>软萌、圆润、治愈系配色</p>
                    </div>
                    <div class="check-mark" id="check-candy"><i class="fas fa-check"></i></div>
                </div>

                <div class="theme-card" onclick="switchTheme('theme-glass')">
                    <div class="theme-preview preview-glass"></div>
                    <div class="theme-info">
                        <h4>✨ 极简磨砂 (Glass)</h4>
                        <p>透明、模糊、iOS高级感</p>
                    </div>
                    <div class="check-mark" id="check-glass"><i class="fas fa-check"></i></div>
                </div>

                <!-- 3. 手绘笔记主题 -->
                <div class="theme-card" onclick="switchTheme('theme-paper')">
                    <!-- 预览圆圈：网格纸背景 -->
                    <div class="theme-preview" style="background: #fdf6e3; background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 10px 10px;"></div>
                    <div class="theme-info">
                        <h4>📝 手绘笔记 (Paper)</h4>
                        <p>温馨、网格纸、涂鸦手写风</p>
                    </div>
                    <div class="check-mark"><i class="fas fa-check"></i></div>
                </div>

                <!-- 4. 3D黏土主题 -->
                <div class="theme-card" onclick="switchTheme('theme-clay')">
                    <!-- 预览圆圈：软紫色 -->
                    <div class="theme-preview" style="background: #F0F4F8; box-shadow: inset 2px 2px 5px #d1d9e6, inset -2px -2px 5px #fff;"></div>
                    <div class="theme-info">
                        <h4>🧊 3D黏土 (Clay)</h4>   
                        <p>软萌、悬浮感、现代极简</p>
                    </div>
                    <div class="check-mark"><i class="fas fa-check"></i></div>
                </div>
            </div>
        </div>

        <!-- 3. 好友列表/动态 复合界面 (V2.0) -->
         <div id="screen-friends" class="screen">
            <div class="header">
    <button class="back-btn" onclick="goToScreen('screen-home')"><i class="fas fa-chevron-left"></i></button>
    
    <h3 id="qq-title">好友列表</h3>
    
    <div style="display: flex; gap: 15px;">
        <!-- 1. 添加好友按钮 (ID: btn-add-friend) -->
        <button id="btn-add-friend" class="add-btn" onclick="goToScreen('screen-add-friend')" style="font-size: 18px;">
            <i class="fas fa-user-plus"></i>
        </button>
        
        <!-- 2. 发动态按钮 (ID: btn-add-moment) -->
        <!-- 注意：这里加了 style="display:none"，默认隐藏，等切换到动态页时再显示 -->
        <button id="btn-add-moment" class="add-btn" onclick="openPostMenu()" style="font-size: 18px; display: none;">
            <i class="fas fa-plus-circle"></i> <!-- 图标变成带圆圈的加号 -->
        </button>
    </div>
</div>

    <!-- 两个子页面的容器 -->
    <div class="content" style="padding:0;">
        <!-- A. 好友列表 (默认显示) -->
        <div id="friend-list-container" class="qq-tab-content active">
            <!-- 好友会通过JS动态加载到这里 -->
        </div>
        <!-- B. 动态/朋友圈 (默认隐藏) -->
        <div id="qzone-feed-container" class="qq-tab-content" style="display:none;">
            <!-- 动态会通过JS加载到这里 -->
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <button id="nav-btn-friends" class="nav-btn active" onclick="switchQqTab('friends')">
            <i class="fas fa-user-friends"></i>
            <span>好友</span>
        </button>
        <button id="nav-btn-moments" class="nav-btn" onclick="switchQqTab('moments')">
            <i class="fas fa-star"></i>
            <span>动态</span>
        </button>
    </div>
</div>

<!-- 3.5. 选择好友发动态 界面 (新增) -->
<div id="screen-select-friends-for-moment" class="screen">
    <div class="header">
        <button class="back-btn" onclick="backToFriendList()"><i class="fas fa-times"></i></button>
        <h3>选择好友发动态</h3>
    </div>
    <div class="content padding" id="moment-friend-select-list">
        <!-- JS会在这里渲染带复选框的好友列表 -->
    </div>
    <div class="confirm-moment-footer">
        <button class="primary-btn" onclick="generateMoments()">
            <i class="fas fa-magic"></i> 让选中的好友发动态
        </button>
    </div>
</div>

        <!-- 4. 添加好友/人设设置界面 -->
        <div id="screen-add-friend" class="screen">
            <div class="header">
                <button class="back-btn" onclick="goToScreen('screen-friends')"><i class="fas fa-chevron-left"></i></button>
                <h3>创建角色</h3>
            </div>
            <div class="content padding scrollable">
                <h4>🤖 角色设定 (AI)</h4>
                <div class="input-group">
                    <input type="text" id="char-name" placeholder="角色名字">
                    <input type="text" id="char-avatar" placeholder="角色头像URL (或使用默认)">
                    <textarea id="char-prompt" rows="4" placeholder="输入角色人设，例如：你是一个傲娇的猫娘..."></textarea>
                </div>

                <hr>

                <h4>👤 你的设定 (用户)</h4>
                <div class="input-group">
                    <input type="text" id="user-name" placeholder="你的名字">
                    <input type="text" id="user-avatar" placeholder="你的头像URL">
                    <textarea id="user-intro" rows="2" placeholder="你的简介/两人关系"></textarea>
                </div>

                <button class="primary-btn" onclick="saveFriend()">保存角色</button>
            </div>
        </div>

        <!-- 5. 聊天界面 (仿LINE) -->
        <div id="screen-chat" class="screen">
            <div class="header chat-header">
                <button class="back-btn" onclick="backToFriendList()"><i class="fas fa-chevron-left"></i></button>
                <h3 id="chat-title">聊天中</h3>
                <button class="menu-btn" onclick="openChatSettings()"><i class="fas fa-bars"></i></button>
            </div>
            <!-- 多选操作栏 (默认隐藏) -->
            <div id="multi-select-bar" class="header select-header" style="display:none;">
                <button class="back-btn" onclick="exitSelectionMode()">取消</button>
                <span id="select-count">已选 0</span>
                <button class="delete-btn" onclick="deleteSelectedMessages()"><i class="fas fa-trash"></i></button>
            </div>
            
            <div class="chat-area" id="chat-box">
                <!-- 聊天记录显示在这里 -->
            </div>
            <!-- 引用消息预览 (默认隐藏) -->
            <div id="quote-preview-box" class="quote-box" style="display:none;">
                <div class="quote-content">
                    <span id="quote-text">引用内容...</span>
                </div>
                <button class="close-quote-btn" onclick="cancelQuote()"><i class="fas fa-times"></i></button>
            </div>

            <!-- 新版底部区域：包含输入条 + 抽屉 -->
            <div class="chat-footer">
                
                <!-- 1. 输入工具条 -->
                <div class="input-bar">
                    <!-- 抽屉开关 -->
                    <button class="tool-btn-toggle" onclick="toggleDrawer()">
                        <i class="fas fa-plus" id="drawer-icon"></i>
                    </button>
                    
                    <!-- 输入框 -->
                    <input type="text" id="message-input" placeholder="聊点什么...">
                    
                    <!-- 两个高频按钮 (放在外面) -->
                    <div class="action-buttons">
                        <button class="send-btn user-send" onclick="sendUserMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="send-btn ai-trigger" onclick="triggerAIResponse()">
                            <i class="fas fa-wand-magic-sparkles"></i>
                        </button>
                    </div>
                </div>

                <!-- 2. 功能抽屉 (标准结构修复版) -->
                <div class="drawer-panel" id="tool-drawer">
                    <div class="drawer-grid">
                        <!-- 相册 -->
                        <div class="drawer-item" onclick="alert('相册功能开发中...')">
                            <div class="d-icon"><i class="fas fa-image"></i></div>
                            <span>相册</span>
                        </div>
                        <!-- 拍照 -->
                        <div class="drawer-item" onclick="alert('拍照功能开发中...')">
                            <div class="d-icon"><i class="fas fa-camera"></i></div>
                            <span>拍照</span>
                        </div>
                        <!-- 视频 -->
                        <div class="drawer-item" onclick="enterVideoCall()">
                            <div class="d-icon"><i class="fas fa-video"></i></div>
                            <span>视频</span>
                        </div>
                        <!-- 位置 -->
                        <div class="drawer-item" onclick="alert('位置共享开发中...')">
                            <div class="d-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <span>位置</span>
                        </div>
                        <!-- 表情 -->
                        <div class="drawer-item" onclick="toggleStickerPanel()">
                            <div class="d-icon"><i class="far fa-laugh-squint"></i></div>
                            <span>表情包</span>
                        </div>
                        <!-- 文件 -->
                        <div class="drawer-item" onclick="alert('发送文件...')">
                            <div class="d-icon"><i class="fas fa-folder-open"></i></div>
                            <span>文件</span>
                        </div>
                        <!-- 语音 -->
                        <div class="drawer-item" onclick="alert('语音通话...')">
                            <div class="d-icon"><i class="fas fa-phone"></i></div>
                            <span>语音</span>
                        </div>
                        <!-- 红包 (注意这里是 openSendPacketModal) -->
                        <div class="drawer-item" onclick="openSendPacketModal()">
                            <div class="d-icon"><i class="fas fa-gift"></i></div>
                            <span>红包</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 6. 聊天具体设置界面 (新增) -->
        <div id="screen-chat-settings" class="screen">
            <div class="header">
                <button class="back-btn" onclick="backToChat()"><i class="fas fa-chevron-left"></i></button>
                <h3>详细设置</h3>
            </div>
            <div class="content padding scrollable">
                
                <!-- A. 基本信息修改 -->
                <div class="setting-section">
                    <h4>📝 设定修改</h4>
                    <div class="input-group">
                        <label>角色名</label>
                        <input type="text" id="edit-char-name">
                    </div>
                    <div class="input-group">
                        <label>角色头像 (点击更换)</label>
                        <div class="avatar-upload" onclick="triggerFileUpload('edit-char-avatar-file')">
                            <img id="preview-char-avatar" src="" class="upload-preview">
                            <span>点击上传本地图片</span>
                        </div>
                        <input type="file" id="edit-char-avatar-file" accept="image/*" style="display:none" onchange="handleFileSelect(this, 'preview-char-avatar')">
                    </div>
                    <div class="input-group">
                        <label>角色人设 (Prompt)</label>
                        <textarea id="edit-char-prompt" rows="3"></textarea>
                    </div>
                    <hr>
                    <div class="input-group">
                        <label>你的名字</label>
                        <input type="text" id="edit-user-name">
                    </div>
                    <div class="input-group">
                        <label>你的头像</label>
                        <div class="avatar-upload" onclick="triggerFileUpload('edit-user-avatar-file')">
                            <img id="preview-user-avatar" src="" class="upload-preview">
                            <span>点击上传本地图片</span>
                        </div>
                        <input type="file" id="edit-user-avatar-file" accept="image/*" style="display:none" onchange="handleFileSelect(this, 'preview-user-avatar')">
                    </div>
                    <!-- 放在“你的头像” input-group 的下面 -->
                    <div class="input-group">
                        <label>你的简介 / 两人关系</label>
                        <textarea id="edit-user-intro" rows="3" placeholder="例如：我是你的青梅竹马，性格比较内向..."></textarea>
                    </div>
                </div>

                <!-- === 新增：互动频率控制 === -->
<div class="setting-section interaction-frequency">
    <h4><i class="fas fa-sliders-h" style="color: #a18cd1;"></i> 互动频率</h4>
    <div class="segmented-control" id="frequency-selector">
        <button class="option-btn" onclick="setActivityLevel('active')" id="btn-freq-active">
            <i class="fas fa-fire"></i> 活跃
        </button>
        <button class="option-btn" onclick="setActivityLevel('standard')" id="btn-freq-standard">
            <i class="fas fa-user-friends"></i> 标准
        </button>
        <button class="option-btn" onclick="setActivityLevel('quiet')" id="btn-freq-quiet">
            <i class="fas fa-leaf"></i> 安静
        </button>
        <button class="option-btn" onclick="setActivityLevel('muted')" id="btn-freq-muted">
            <i class="fas fa-moon"></i> 沉睡
        </button>
    </div>
    <p id="freq-desc-text" class="option-description">
        选择角色的活跃程度...
    </p>
</div>

                <!-- B. 外观设置 -->
                <div class="setting-section">
                    <h4>🎨 外观定制</h4>
                    
                    <div class="input-group">
                        <label>聊天背景图</label>
                        <div class="avatar-upload" onclick="triggerFileUpload('bg-file')">
                            <img id="preview-bg" src="" class="upload-preview" style="width:100%; height:100px; object-fit:cover;">
                            <span>点击选择背景</span>
                        </div>
                        <input type="file" id="bg-file" accept="image/*" style="display:none" onchange="handleFileSelect(this, 'preview-bg')">
                        <button class="small-btn" onclick="clearBackground()">清除背景</button>
                    </div>

                    <label>💬 气泡样式 (CSS)</label>
                    
                    <!-- 样式预设区 -->
                    <div class="preset-area">
                        <label>预设方案：</label>
                        <select id="bubble-preset-select" onchange="loadBubblePreset()">
                            <option value="">-- 选择预设 --</option>
                        </select>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <input type="text" id="new-preset-name" placeholder="新预设名称" style="flex:1;">
                            <button class="small-btn" onclick="saveAsPreset()">保存为预设</button>
                        </div>
                    </div>

                    <!-- CSS 编辑区 -->
                    <div class="css-editor">
                        <label>AI 气泡 CSS:</label>
                        <textarea id="css-ai-bubble" rows="3" oninput="updatePreview()"></textarea>
                        
                        <label>用户 气泡 CSS:</label>
                        <textarea id="css-user-bubble" rows="3" oninput="updatePreview()"></textarea>
                    </div>

                    <!-- 实时预览框 -->
                    <div class="preview-box" id="style-preview-box">
                        <div class="message ai">
                            <img src="" class="msg-avatar preview-ai-avatar">
                            <div class="msg-bubble" id="preview-bubble-ai">AI 的气泡样式预览</div>
                        </div>
                        <div class="message user">
                            <div class="msg-bubble" id="preview-bubble-user">我的气泡样式预览</div>
                            <img src="" class="msg-avatar preview-user-avatar">
                        </div>
                    </div>
                </div>

                <button class="primary-btn" onclick="saveChatSettings()">保存所有修改</button>
                <div style="height: 50px;"></div>
            </div>
        </div>

    </div>

    <!-- 7. 新增：视频通话记录回顾弹窗 -->
<div id="modal-video-history" class="modal-overlay" onclick="closeVideoHistoryModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="history-header">
            <h3><i class="fas fa-film"></i> 通话剧本</h3>
            <button class="close-btn" onclick="closeVideoHistoryModal()" style="background:none; border:none; color:#D4AF37; font-size:18px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="video-script-list" class="script-list">
            <!-- JS 会把剧本渲染在这里 -->
        </div>
    </div>
</div>

    <!-- ============================================== -->
    <!-- 6. 新增：视频通话界面 (磨砂黑金版) -->
    <!-- ============================================== -->
    <div id="screen-video-call" class="screen">
        <div class="phone-frame-inner">
            <!-- 纯净星空背景 -->
            <div id="star-bg" class="bg-layer"></div>

            <!-- 界面交互层 -->
            <div class="interface-layer">
                
                <!-- 顶部：角色小窗 + 挂断 -->
                <div class="video-top-bar">
                    <div class="pip-window">
                        <!-- 这里的头像会由 JS 自动替换 -->
                        <img id="video-partner-avatar" src="" class="pip-img">
                        <!-- 音频波形 -->
                        <div class="wave-container">
                            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                        </div>
                    </div>
                    
                    <button class="btn-hangup" onclick="exitVideoCall()"><i class="fas fa-phone-slash"></i></button>
                </div>

                <!-- 聊天区域 -->
                <div class="video-chat-area" id="video-chat-box">
                    <!-- 消息会显示在这里 -->
                </div>

                <!-- 底部：输入 + 双按钮 -->
                <div class="video-bottom-bar">
                    <input type="text" id="video-input" class="video-input-box" placeholder="输入回复...">
                    
                    <!-- 获取回复 (Magic) -->
                    <button class="circle-btn btn-magic" onclick="triggerVideoAI(false)" title="让AI回应">
                        <i class="fas fa-wand-magic-sparkles"></i>
                    </button>
                    
                    <!-- 发送消息 (Send) -->
                    <button class="circle-btn btn-send" onclick="sendVideoMessage()" title="发送">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <!-- 消息操作菜单 (Action Sheet) -->
    <div id="msg-action-menu" class="modal-overlay" onclick="closeActionMenu()">
        <div class="action-sheet" onclick="event.stopPropagation()">
            <div class="action-item" onclick="handleMenuAction('reply')"><i class="fas fa-reply"></i> 引用</div>
            <div class="action-item" onclick="handleMenuAction('copy')"><i class="fas fa-copy"></i> 复制</div>
            <div class="action-item" onclick="handleMenuAction('edit')"><i class="fas fa-pen"></i> 编辑</div>
            <div class="action-item" onclick="handleMenuAction('regenerate')" id="btn-regen"><i class="fas fa-sync-alt"></i> 重生成</div>
            <div class="action-item" onclick="handleMenuAction('multi')"><i class="fas fa-check-circle"></i> 多选</div>
            <div class="action-item destruct" onclick="handleMenuAction('delete')"><i class="fas fa-trash"></i> 删除</div>
        </div>
    </div>

    <!-- 消息编辑弹窗 -->
    <div id="msg-edit-modal" class="modal-overlay">
        <div class="edit-box">
            <h3>编辑消息</h3>
            <textarea id="edit-msg-content" rows="5"></textarea>
            <div class="edit-buttons">
                <button onclick="closeEditModal()">取消</button>
                <button class="primary" onclick="confirmEditMessage()">确定</button>
            </div>
        </div>
    </div>
    <!-- 1. 发红包填写弹窗 -->
    <div id="modal-send-packet" class="modal-overlay">
        <div class="packet-modal">
            <div class="packet-header">
                <h3>发红包</h3>
                <button class="close-btn" onclick="closePacketModal('modal-send-packet')"><i class="fas fa-times"></i></button>
            </div>
            <div class="packet-body">
                <div class="money-input">
                    <span>¥</span>
                    <input type="number" id="packet-amount" placeholder="0.00">
                </div>
                <input type="text" id="packet-text" class="text-input" placeholder="恭喜发财，大吉大利">
                <button class="packet-btn-primary" onclick="confirmSendPacket()">塞钱进红包</button>
            </div>
        </div>
    </div>

    <!-- 2. 拆红包/操作弹窗 -->
    <!-- 修改点：添加了 onclick="closePacketModal..." 让点击背景能关闭 -->
    <div id="modal-open-packet" class="modal-overlay" onclick="closePacketModal('modal-open-packet')">
        <!-- 修改点：添加了 onclick="event.stopPropagation()" 防止点红包本体时误关闭 -->
        <div class="packet-modal open-style" onclick="event.stopPropagation()">
            <div class="red-bg">
                <div class="avatar-wrapper">
                    <img id="packet-sender-avatar" src="">
                </div>
                <h4 id="packet-sender-name">谁发的红包</h4>
                <p id="packet-msg-preview">祝福语</p>
            </div>
            <div class="packet-result">
                <h2 id="packet-money-display">¥ ??</h2>
                <div id="packet-actions" class="packet-actions">
                    <button class="action-btn receive" onclick="handlePacketAction('receive')">领取红包</button>
                    <button class="action-btn return" onclick="handlePacketAction('return')">退回红包</button>
                </div>
                <p id="packet-status-text" style="display:none; color:#999; margin-top:20px;">已领取/已退回</p>
            </div>
        </div>
    </div>
    <!-- === 新增：表情包面板 (默认隐藏) === -->
<div id="sticker-panel" class="sticker-panel" style="display:none;">
    <div class="sticker-header">
        <span>我的表情包</span>
        <button class="add-sticker-btn" onclick="openAddStickerModal()">
            <i class="fas fa-plus"></i> 添加
        </button>
    </div>
    <div id="sticker-grid" class="sticker-grid">
        <!-- JS 会把表情渲染在这里 -->
    </div>
</div>

<!-- === 新增：添加表情包弹窗 === -->
<div id="modal-add-sticker" class="modal-overlay">
    <div class="packet-modal">
        <div class="packet-header">
            <h3>添加表情包</h3>
            <button class="close-btn" onclick="closePacketModal('modal-add-sticker')"><i class="fas fa-times"></i></button>
        </div>
        <div class="packet-body">
            <div class="avatar-upload" onclick="triggerFileUpload('sticker-file-input')">
                <img id="preview-sticker-upload" src="" class="upload-preview" style="object-fit: contain;">
                <span>点击上传图片</span>
            </div>
            <input type="file" id="sticker-file-input" accept="image/*" style="display:none" onchange="handleFileSelect(this, 'preview-sticker-upload')">
            
            <p style="font-size:12px; color:#666;">告诉AI这张图是什么意思（重要）：</p>
            <input type="text" id="sticker-desc" class="text-input" placeholder="例如：一只哭泣的猫猫，表示委屈">
            
            <button class="packet-btn-primary" onclick="confirmAddSticker()">保存表情</button>
        </div>
    </div>
</div>
<!-- 动态图片详情弹窗 -->
<div id="modal-moment-image-detail" class="modal-overlay" onclick="closeImageDetailModal()">
    <div class="moment-image-modal" onclick="event.stopPropagation()">
        <div class="moment-image-placeholder">
            <i class="fas fa-image"></i>
            <span>AI 生成的图片(占位符)</span>
        </div>
        <div id="moment-image-description" class="moment-image-desc">
            这里是AI生成的图片详细描述...
        </div>
    </div>
</div>

<!-- === 新增 1: 发布类型选择菜单 (用户发还是让AI发) === -->
<div id="modal-post-menu" class="modal-overlay" onclick="closePostMenu()">
    <div class="action-sheet" onclick="event.stopPropagation()">
        <div class="action-item" onclick="openUserPostModal()">
            <i class="fas fa-user-edit" style="color: #FF9A9E;"></i> 我要发动态
        </div>
        <div class="action-item" onclick="openFriendSelectionForMoment()">
            <i class="fas fa-magic" style="color: #a18cd1;"></i> 让 AI 好友发动态
        </div>
    </div>
</div>

<!-- === 新增 2: 用户发布动态的填写弹窗 === -->
<div id="modal-user-post" class="screen">
    <div class="header">
        <button class="back-btn" onclick="closeUserPostModal()"><i class="fas fa-times"></i></button>
        <h3>发布动态</h3>
        <button class="add-btn" onclick="submitUserPost()" style="font-size: 16px; font-weight: bold; color: #4facfe;">发布</button>
    </div>
    <div class="content padding">
        <!-- 文本内容 -->
        <textarea id="user-post-text" rows="4" placeholder="这一刻的想法..." style="border:none; background:transparent; font-size:16px;"></textarea>
        
        <!-- 图片描述 (仿照AI逻辑) -->
        <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <p style="font-size: 12px; color: #999; margin-bottom: 5px;"><i class="fas fa-image"></i> 图片内容描述 (AI也能看懂)</p>
            <input type="text" id="user-post-img-desc" placeholder="例如：一张我在海边拿着冰淇淋的自拍" style="background: white;">
        </div>

        <!-- 可见范围选择 -->
        <h4 style="margin-bottom: 10px; color: #666;">谁可以看见 (并进行互动)</h4>
        <div id="user-post-visibility-list" class="scrollable" style="max-height: 300px; overflow-y: auto;">
            <!-- JS 会在这里渲染好友复选框 -->
        </div>
    </div>
</div>

<!-- === 新增：通用底部操作菜单 (删除动态/评论用) === -->
<div id="universal-action-menu" class="modal-overlay" onclick="closeUniversalMenu()">
    <div class="action-sheet" onclick="event.stopPropagation()">
        <!-- 这里的内容会由 JS 动态生成 -->
        <div id="action-sheet-content"></div>
        <div class="action-item cancel" onclick="closeUniversalMenu()" style="border-top: 5px solid #f0f2f5; justify-content: center;">取消</div>
    </div>
</div>

<!-- === 新增：通用二次确认弹窗 === -->
<div id="universal-confirm-modal" class="modal-overlay">
    <div class="confirm-box" onclick="event.stopPropagation()">
        <h3 id="confirm-title">确认删除？</h3>
        <p id="confirm-desc">此操作无法撤销。</p>
        <div class="confirm-buttons">
            <button class="btn-cancel" onclick="closeConfirmModal()">取消</button>
            <button class="btn-confirm destruct" onclick="executeDelete()">删除</button>
        </div>
    </div>
</div>

<!-- === 新增：选择召唤对象的弹窗 === -->
<div id="modal-summon-selection" class="modal-overlay" onclick="closeSummonModal()">
    <div class="packet-modal" onclick="event.stopPropagation()">
        <div class="packet-header">
            <h3>选择要召唤的角色</h3>
            <button class="close-btn" onclick="closeSummonModal()"><i class="fas fa-times"></i></button>
        </div>
        <div id="summon-friend-list" class="summon-list">
            <!-- JS 渲染列表 -->
        </div>
    </div>
</div>

<!-- ▼▼▼ 请将这段代码粘贴到 index.html 的 </body> 标签之前 ▼▼▼ -->

<!-- ==============================================
   新增：AI 主动来电呼叫界面
   ============================================== -->
<div id="screen-incoming-call" class="screen">
    <div class="incoming-call-bg"></div>
    <div class="caller-info">
        <img id="caller-avatar" src="" class="caller-avatar">
        <h2 id="caller-name">角色名</h2>
        <p id="caller-status">正在邀请你进行视频通话...</p>
        <p id="caller-reason">“我想打电话给你...”</p>
    </div>
    <div class="call-actions">
        <div class="action-btn-call-wrapper">
            <button class="call-btn decline" onclick="declineCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
            <span>拒接</span>
        </div>
        <div class="action-btn-call-wrapper">
            <button class="call-btn accept" onclick="acceptCall()">
                <i class="fas fa-video"></i>
            </button>
            <span>接听</span>
        </div>
    </div>
</div>
</body>
</html>