<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Otome - LoveOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="app-container">
        <audio id="audio-bgm" loop></audio> 
        <div id="sfx-container"></div>

        <!-- 背景层 -->
        <div class="layer-bg">
            <img id="bg-img" src="" class="full-cover transition-all duration-1000 scale-110">
            <div id="bg-placeholder" class="absolute inset-0 bg-[#0a0a0a] flex items-center justify-center text-[#333] text-xs tracking-[0.3em] font-serif">NO SIGNAL</div>
        </div>

        <div id="fx-back" class="layer-fx-back pointer-events-none absolute inset-0 transition-opacity duration-1000"></div>

        <!-- 角色层 -->
        <div class="layer-char">
            <div id="char-wrapper">
                <img id="char-img" src="" class="full-cover hidden breathing"> 
            </div>
        </div>

        <div id="fx-front" class="layer-fx-front pointer-events-none absolute inset-0 z-[5]"></div>

        <!-- UI 层 -->
        <div class="layer-ui flex flex-col justify-between p-6">
            
            <!-- ==== 左上角状态监视器==== -->
            <div class="absolute top-6 left-6 z-50 pointer-events-auto font-sans">
    
                <!-- 1. 常驻小胶囊  -->
                <button onclick="statusManager.toggle()" id="status-trigger" class="flex items-center gap-3 bg-black/40 backdrop-blur-md border border-white/10 rounded-full pl-1 pr-4 py-1 hover:bg-black/60 hover:border-[#D4AF37]/50 transition-all group">
                    <div class="w-6 h-6 rounded-full bg-[#D4AF37] flex items-center justify-center text-black text-xs group-hover:scale-110 transition-transform">
                        <i class="ph-fill ph-broadcast"></i>
                    </div>
                    <div class="flex flex-col items-start leading-none">
                        <span class="text-[8px] text-[#D4AF37] tracking-widest font-bold">SYSTEM</span>
                        <span class="text-[10px] text-gray-300 font-serif" id="mini-status-text">Online</span>
                    </div>
                </button>

    <!-- 2. 展开后的毛玻璃面板 (默认隐藏) -->
    <div id="status-panel" class="absolute top-10 left-0 w-[260px] bg-[#1a1a1a]/80 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl opacity-0 pointer-events-none transition-all duration-300 scale-95 origin-top-left">
        
        <!-- 面板顶部：标签页切换 -->

        <div class="flex border-b border-white/10 pb-2 mb-3 gap-4">
            <button onclick="statusManager.switchTab('main')" class="status-tab active text-[10px] font-bold text-[#D4AF37] tracking-widest hover:text-white" data-tab="main">环境</button>
            <button onclick="statusManager.switchTab('core')" class="status-tab text-[10px] font-bold text-gray-600 tracking-widest hover:text-white" data-tab="core">核心</button>
            <button onclick="statusManager.switchTab('sys')"  class="status-tab text-[10px] font-bold text-gray-600 tracking-widest hover:text-white" data-tab="sys">系统</button>
            <button onclick="statusManager.toggle()" class="ml-auto text-gray-500 hover:text-white"><i class="ph ph-x"></i></button>
        </div>

        <!-- 内容区域 -->
        <div id="status-content">
            
            <!-- Tab 1: MAIN (视听与环境) -->
            <div id="status-view-main" class="status-view space-y-3">
                
                <!-- 音乐卡片 -->
                <div>
                    <div class="text-[9px] text-gray-500 mb-1 tracking-wider">NOW PLAYING</div>
                    <div class="flex items-center gap-3 bg-black/20 p-2 rounded-lg border border-white/5">
                        <div class="w-8 h-8 bg-[#D4AF37]/20 rounded flex items-center justify-center text-[#D4AF37]">
                            <i class="ph-fill ph-music-note"></i>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="status-bgm-name" class="text-[10px] text-white truncate font-serif">No Signal</div>
                            <div id="status-sfx-name" class="text-[9px] text-gray-500 truncate">Silence</div>
                        </div>
                        <i class="ph ph-waveform text-[#D4AF37] animate-pulse"></i>
                    </div>
                </div>

                <!-- 天气同步对比 -->
                <div>
                    <div class="text-[9px] text-gray-500 mb-1 tracking-wider">ENV SYNC (WEATHER)</div>
                    <div class="flex gap-2">
                        <!-- 用户端 (自动获取) -->
                        <div class="flex-1 bg-white/5 rounded p-2 text-center border border-white/5">
                            <div class="text-[8px] text-gray-400 mb-1">LOCAL (YOU)</div>
                            <i id="weather-icon-local" class="ph ph-cloud text-lg text-gray-300 mb-1"></i>
                            <div id="weather-text-local" class="text-[10px] font-bold">--°C</div>
                        </div>
                        <!-- AI端 (基于设定) -->
                        <div class="flex-1 bg-[#D4AF37]/10 rounded p-2 text-center border border-[#D4AF37]/30 relative overflow-hidden">
                            <div class="absolute -right-2 -top-2 w-6 h-6 bg-[#D4AF37] blur-lg opacity-20"></div>
                            <div class="text-[8px] text-[#D4AF37] mb-1">HOST (HIM)</div>
                            <i id="weather-icon-ai" class="ph-fill ph-cloud-rain text-lg text-[#D4AF37] mb-1"></i>
                            <div id="weather-text-ai" class="text-[10px] font-bold text-[#D4AF37]">Syncing...</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Tab 2: CORE (核心状态 - 灵魂链接) -->
<div id="status-view-core" class="status-view hidden">
    
    <div class="text-[9px] text-gray-600 tracking-[0.2em] text-center mb-2 uppercase">Consciousness // 意识</div>

    <!-- 灵魂球 -->
    <div class="soul-orb">
        <div id="core-aff-num" class="text-xl text-[#D4AF37] font-serif font-bold">--%</div>
        <div class="text-[7px] text-gray-500 uppercase tracking-widest mt-1">同步率</div>
        <!-- 情感色块背景 -->
        <div id="core-mood-glow" class="mood-glow"></div>
    </div>

    <!-- 思维流 -->
    <div class="mb-1 flex justify-between items-end">
        <span class="text-[8px] text-gray-600 tracking-widest uppercase">Thought Stream</span>
        <i class="ph-fill ph-chat-teardrop-text text-gray-700 text-xs"></i>
    </div>
    <div class="thought-stream" id="core-thought-stream">
        <div class="thought-item">正在建立神经链接...</div>
    </div>

    <!-- 生理指标 -->
    <div class="text-[9px] text-gray-600 tracking-[0.2em] mb-2 mt-4 uppercase border-t border-white/5 pt-2">Physiology // 生理</div>

    <!-- 精力 -->
    <div class="vital-card">
        <div class="vital-label"><i class="ph-fill ph-lightning text-gray-500"></i> 精力</div>
        <div class="vital-dots" id="dots-energy"></div>
    </div>

    <!-- 饱腹 -->
    <div class="vital-card">
        <div class="vital-label"><i class="ph-fill ph-hamburger text-gray-500"></i> 饱腹</div>
        <div class="vital-dots" id="dots-satiety"></div>
    </div>

    <!-- 理智 -->
    <div class="vital-card">
        <div class="vital-label"><i class="ph-fill ph-brain text-gray-500"></i> 理智</div>
        <div class="vital-dots" id="dots-sanity"></div>
    </div>
</div>

            <!-- Tab 3: SYS (未来扩展预留) -->
            <div id="status-view-sys" class="status-view hidden space-y-2">
                <div class="flex justify-between text-[9px] text-gray-400 border-b border-white/5 pb-1">
                    <span>UPTIME</span> <span class="text-white font-mono">03:12:45</span>
                </div>
                <div class="flex justify-between text-[9px] text-gray-400 border-b border-white/5 pb-1">
                    <span>LATENCY</span> <span class="text-green-400 font-mono">24ms</span>
                </div>
                <div class="flex justify-between text-[9px] text-gray-400">
                    <span>VERSION</span> <span class="text-white font-mono">LoveOS v1.2</span>
                </div>
            </div>

        </div>
    </div>
</div>
            <!-- 顶部按钮 -->
            <div class="flex justify-end pt-2 pointer-events-auto gap-4">
                <button onclick="uiManager.openSettings()" class="text-white/50 hover:text-[#D4AF37] transition">
                    <i class="ph ph-list text-2xl"></i>
                </button>
                <button onclick="dockManager.toggle()" class="text-white/50 hover:text-[#D4AF37] transition" title="功能菜单">
                    <i class="ph ph-squares-four text-2xl"></i>
                </button>
            </div>

            <!-- 底部对话区与输入框 -->
            <div class="flex flex-col gap-4 pb-2 pointer-events-auto">
                <div id="dialogue-box" class="editorial-box hidden" onclick="director.next()">
                    <div class="editorial-header">
                        <div id="char-name" class="name-gold">LOADING</div>
                        <button onclick="event.stopPropagation(); historyManager.show()" class="log-btn">LOG</button>
                    </div>
                    <p id="dialogue-text" class="text-content">...</p>
                    <div class="nav-controls">
                        <button id="btn-prev" class="nav-arrow hidden" onclick="event.stopPropagation(); director.prev()">
                            <i class="ph ph-caret-left"></i> BACK
                        </button>
                        <div id="indicator-next" class="nav-arrow right">
                            NEXT <i class="ph ph-caret-right"></i>
                        </div>
                    </div>
                </div>

                <!-- ==== 完美适配版输入栏 ==== -->
                <div class="input-glass-bar">
                    <!-- 1. 左侧：模式切换 -->
                    <button id="mode-btn" onclick="aiEngine.toggleMode()" class="mode-switch-text">
                        对话模式
                    </button>
                    
                    <!-- 2. 分割线 -->
                    <div class="input-divider"></div>

                    <!-- 3. 中间：输入框 (自适应) -->
                    <input type="text" id="user-input" placeholder="输入..." autocomplete="off"
                           onkeypress="if(event.keyCode==13) aiEngine.queueInput()">

                    <!-- 4. 右侧：按钮组 (固定不缩放) -->
                    <div class="action-buttons">
                        <!-- 发送键 -->
                        <button onclick="aiEngine.queueInput()" id="send-btn" class="btn-send-style" title="存入剧本">
                            <i class="ph ph-paper-plane-right"></i>
                        </button>
                        
                        <!-- 生成键 -->
                        <button onclick="aiEngine.triggerResponse()" id="trigger-btn" class="btn-sparkle" title="生成回复">
                            <i class="ph ph-sparkle"></i>
                        </button>
                    </div>
                </div>
                <!-- ==== 输入栏结束 ==== -->
            </div>
        </div>

        <!-- 历史记录面板 -->
        <div id="history-modal" class="absolute inset-0 z-40 bg-[#0a0a0a]/95 backdrop-blur-md flex flex-col transition-opacity duration-300 opacity-0 pointer-events-none">
            <div class="p-8 border-b border-white/10 flex justify-between items-center">
                <span class="text-[#D4AF37] text-xs tracking-[0.2em] font-serif">剧情记录</span>
                <button onclick="historyManager.hide()" class="text-gray-500 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-8 space-y-6 scrollbar-hide"></div>
            <div class="p-4 border-t border-white/10 text-center">
                <button onclick="historyManager.clear()" class="text-[10px] text-red-900 hover:text-red-500 tracking-widest uppercase transition">清空当前记录</button>
            </div>
            <!-- 多选模式：顶部栏 -->
            <div id="batch-bar">
                <span id="batch-count">已选择 0 项</span>
                <button onclick="historyManager.exitBatchMode()" class="px-3 py-1 bg-black/20 rounded hover:bg-black/40 transition">完成</button>
            </div>

<!-- 多选模式：底部悬浮删除 -->
<button id="batch-delete-fab" onclick="historyManager.deleteBatch()">
    <i class="ph ph-trash"></i> 确认删除
</button>
        </div>

        <!-- 素材编辑 -->
<div id="asset-modal" class="absolute inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center transition-opacity duration-200 opacity-0 pointer-events-none">
    <div class="asset-card" onclick="event.stopPropagation()">
        <!-- 预览区 -->
        <div id="asset-preview-area" class="w-full h-48 bg-[#111] flex items-center justify-center border-b border-white/10 relative overflow-hidden"></div>
        
        <div class="p-6 space-y-4">
            <!-- 1. 修改分类 (新增功能) -->
            <div class="input-group">
                <label>TYPE (分类)</label>
                <select id="edit-asset-type" class="mono-input mt-1">
                    <option value="char">立绘 (Char)</option>
                    <option value="bg">背景 (Bg)</option>
                    <option value="bgm">BGM</option>
                    <option value="sfx">音效 (SFX)</option>
                </select>
            </div>

            <!-- 2. 修改标签 -->
            <div class="input-group">
                <label class="flex justify-between">
                    <span>TAG (标签)</span>
                    <span class="text-[9px] text-gray-500">点击下方添加</span>
                </label>
                <div class="flex items-center border-b border-white/30 pb-1 gap-2">
                    <i class="ph ph-tag text-gray-500"></i>
                    <input type="text" id="edit-asset-tag" class="bg-transparent border-none text-white text-sm w-full focus:outline-none font-mono" autocomplete="off">
                    <button onclick="tagManager.addFromInput('edit-asset-tag')" class="text-[#D4AF37] hover:text-white text-xs"><i class="ph ph-plus"></i></button>
                </div>
                <div id="edit-tag-bank" class="flex gap-2 mt-2 overflow-x-auto pb-1 scrollbar-hide h-8 items-center"></div>
            </div>

            <!-- 3. 修改归属 -->
            <div class="input-group">
                <label>SCOPE (归属)</label>
                <div class="flex gap-2 mt-2">
                    <button onclick="assetManager.setEditScope('global')" id="scope-btn-global" class="scope-chip"><i class="ph ph-globe"></i> 全局通用</button>
                    <button onclick="assetManager.setEditScope('local')" id="scope-btn-local" class="scope-chip"><i class="ph ph-user"></i> 角色专属</button>
                </div>
            </div>

            <!-- 按钮组 -->
            <div class="flex gap-3 pt-2">
                <button onclick="assetManager.deleteAsset()" class="flex-1 border border-red-900/50 text-red-700 hover:bg-red-900/20 py-2 text-xs tracking-widest transition">DELETE</button>
                <button onclick="assetManager.saveChanges()" class="flex-[2] bg-[#D4AF37] text-black font-bold py-2 text-xs tracking-widest hover:opacity-90 transition">SAVE CHANGES</button>
            </div>
        </div>
        <button onclick="assetManager.closeModal()" class="absolute top-2 right-2 text-white/50 hover:text-white bg-black/50 rounded-full p-1"><i class="ph ph-x"></i></button>
    </div>
</div>

        <!-- 设置面板 -->
        <div id="settings-modal" class="absolute inset-0 z-50 bg-[#050505] transition-transform duration-300 translate-y-full flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-white/10">
                <h2 class="text-[#D4AF37] text-lg font-serif italic">系统配置</h2>
                <button onclick="uiManager.closeSettings()" class="text-gray-500 hover:text-white"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <div class="flex px-6 pt-6 gap-6 border-b border-white/5 overflow-x-auto scrollbar-hide">
                <button onclick="uiManager.switchTab('brain')" class="tab-btn active" data-tab="brain">大脑</button>
                <button onclick="uiManager.switchTab('persona')" class="tab-btn" data-tab="persona">人设</button>
                <button onclick="uiManager.switchTab('assets')" class="tab-btn" data-tab="assets">素材</button>
                <button onclick="uiManager.switchTab('data')" class="tab-btn" data-tab="data">数据</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 scrollbar-hide font-sans">
                <!-- Tab 1: Brain -->
                <div id="tab-brain" class="tab-content space-y-6">
                    <div class="input-group"><label>API 地址 (URL)</label><input type="text" id="api-url" class="mono-input" autocomplete="off"></div>
                    <div class="input-group"><label>API 密钥 (KEY)</label><input type="text" id="api-key" class="mono-input" autocomplete="off"></div>
                    <div class="input-group">
                        <label>模型选择</label>
                        <div class="flex gap-2"><select id="api-model" class="mono-input flex-1"></select><button onclick="aiEngine.fetchModels()" class="gold-btn-outline">测试连接</button></div>
                        <div id="brain-status" class="text-[10px] text-gray-500 mt-1 text-right">未连接</div>
                    </div>
                    
                    <div class="border-t border-white/10 pt-4 mt-2">
                        <div class="flex justify-between items-center">
                            <label class="text-gray-400 text-xs">开启 3D 视差 (陀螺仪)</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in" onclick="parallaxManager.toggle()">
                                <input type="checkbox" id="gyro-toggle" class="absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-5"/>
                                <label for="gyro-toggle" class="block overflow-hidden h-5 rounded-full bg-gray-800 cursor-pointer border border-gray-600"></label>
                            </div>
                        </div>
                        <p class="text-[9px] text-gray-600 mt-1">晃动手机以感受伪3D效果。</p>
                    </div>
                </div>

                <!-- Tab 2: Persona -->
<div id="tab-persona" class="tab-content hidden flex flex-col h-full">
    <!-- 1. 顶部：角色切换列表 -->
    <div class="mb-6">
        <label class="block font-inter text-[9px] text-[#666] tracking-widest mb-3">当前角色</label>
        <div id="char-list" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide"></div>
        <button onclick="characterManager.createNew()" class="mt-2 text-[10px] text-[#D4AF37] border-b border-[#D4AF37] pb-1 hover:text-white hover:border-white transition">+ 新建角色</button>
    </div>

    <!-- 2. 中间：滚动区域 -->
    <div class="space-y-8 flex-1 overflow-y-auto pr-2">
        
        <!-- AI 角色设定 -->
        <div class="space-y-4">
            <div class="section-title flex justify-between">
                <span>角色设定</span>
                <button onclick="characterManager.deleteCurrent()" class="text-[9px] text-red-800 hover:text-red-500">删除角色</button>
            </div>
            <div class="input-group">
                <label>角色姓名</label>
                <input type="text" id="persona-name" class="mono-input" autocomplete="off">
            </div>
            <div class="input-group">
                <label>性格与背景描述</label>
                <textarea id="persona-prompt" rows="6" class="mono-input"></textarea>
            </div>
        </div>
        
        <!-- 玩家设定 -->
        <div class="space-y-4">
            <div class="section-title">你的设定 (玩家)</div>
            <div class="input-group">
                <label>你的名字</label>
                <input type="text" id="user-name" class="mono-input" autocomplete="off">
            </div>
            <div class="input-group">
                <label>你的外貌/性格描述</label>
                <textarea id="user-desc" rows="3" class="mono-input"></textarea>
            </div>
            <div class="input-group">
                <label>你们的关系</label>
                <input type="text" id="user-relation" class="mono-input" autocomplete="off">
            </div>
        </div>
    </div>
</div>

                <!-- Tab 3: Assets -->
                <div id="tab-assets" class="tab-content hidden flex flex-col h-full">
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
    <button onclick="assetManager.filter('all')" class="filter-chip active" data-filter="all">全部</button>
    <button onclick="assetManager.filter('char')" class="filter-chip" data-filter="char">立绘</button>
    <button onclick="assetManager.filter('bg')" class="filter-chip" data-filter="bg">背景</button>
    <button onclick="assetManager.filter('bgm')" class="filter-chip" data-filter="bgm">音乐</button>
    <button onclick="assetManager.filter('sfx')" class="filter-chip" data-filter="sfx">音效</button>
</div>
                    <div class="flex gap-2 mb-4">
                        <div class="flex-1 relative">
                            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                            <input type="text" id="asset-search" placeholder="搜索素材..." class="w-full bg-[#111] border border-white/10 text-white text-xs py-2 pl-8 pr-2 focus:border-[#D4AF37] outline-none transition" oninput="assetManager.refreshCache()">
                        </div>
                    </div>
                    <div class="border border-white/10 p-4 mb-4">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <select id="upload-type" class="mono-input">
                                <option value="char">立绘</option>
                                <option value="bg">背景</option>
                                <option value="bgm">BGM</option>
                                <option value="sfx">音效</option>
                            </select>
                            <div class="relative flex items-center">
                                <input type="text" id="upload-tag" placeholder="标签名..." class="mono-input pr-8" autocomplete="off">
                                <button onclick="tagManager.addFromInput('upload-tag')" class="absolute right-2 text-[#D4AF37] hover:text-white" title="存为常用标签">
                                    <i class="ph ph-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div id="upload-tag-bank" class="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide h-8 items-center"></div>
                        <div class="flex items-center justify-between gap-2 mb-3">
                            <div class="flex items-center gap-2 cursor-pointer" onclick="document.getElementById('upload-exclusive').click()">
                                <input type="checkbox" id="upload-exclusive" class="accent-[#D4AF37]">
                                <label for="upload-exclusive" class="text-[10px] text-gray-400 cursor-pointer select-none">专属</label>
                            </div>
                            <button onclick="document.getElementById('upload-file').click()" class="bg-[#D4AF37] text-black px-4 py-1 text-xs font-bold hover:opacity-90 flex items-center gap-1">
                                <i class="ph ph-upload-simple"></i> 上传文件
                            </button>
                            <input type="file" id="upload-file" class="hidden" multiple onchange="assetManager.handleQuickUpload(this)">
                        </div>
                    </div>
                    <div id="assets-list" class="flex-1 overflow-y-auto grid grid-cols-3 gap-3 content-start pr-1 pb-10"></div>
                </div>

                <!-- Tab 4: Data -->
                <div id="tab-data" class="tab-content hidden space-y-6">
                    <div class="border border-white/10 p-6 flex flex-col gap-4">
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">备份与恢复</p>
                        <button onclick="dataManager.backup()" class="gold-btn-outline py-3 flex items-center justify-center gap-2">导出备份文件 (.json)</button>
                        <div class="relative"><button onclick="document.getElementById('restore-file').click()" class="gold-btn-outline py-3 w-full flex items-center justify-center gap-2 border-white/30 text-gray-400 hover:text-white hover:border-white">恢复备份文件</button><input type="file" id="restore-file" class="hidden" onchange="dataManager.restore(this)"></div>
                        <div class="border-t border-white/10 mt-4 pt-4"><button onclick="characterManager.resetMemory()" class="text-[10px] text-red-900 hover:text-red-500 w-full text-left">重置当前角色记忆</button></div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-white/10"><button onclick="app.saveAllSettings()" class="gold-btn w-full py-3">保存设置</button></div>
        </div>

        <div id="start-overlay" class="layer-overlay bg-[#050505]" onclick="app.start()">
            <div class="text-[#D4AF37] text-3xl font-serif italic tracking-widest mb-4">Wake Up</div>
            <div class="text-gray-600 text-[10px] tracking-[0.5em] uppercase">点击唤醒</div>
        </div>
    </div>

<!-- ==== 日记系统全屏弹窗 (新版) ==== -->
<div id="journal-modal" class="fixed inset-0 z-[80] bg-black/90 backdrop-blur-md flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none invisible">
    
    <!-- 窗口容器 -->
    <div class="journal-window w-full h-full md:w-[400px] md:h-[85vh] md:max-h-[900px] bg-[#050505] md:border border-[#333] md:rounded-[40px] flex flex-col relative overflow-hidden shadow-2xl">
        
        <!-- === 1. 头部 (固定定位) === -->
        <header class="journal-new-header">
            <!-- 上半部分：日期与关闭 -->
            <div class="header-top">
                <!-- 点击触发日历 -->
                <div class="date-trigger" onclick="journalManager.showCalendar()">
                    <span id="journal-header-day" class="date-day">--</span>
                    <div class="date-meta">
                        <span id="journal-header-month" class="date-month">---</span>
                        <span id="journal-year-display" class="date-year">----</span>
                    </div>
                </div>

                <!-- 关闭按钮 -->
                <button onclick="journalManager.close()" class="close-btn">
                    <i class="ph ph-x"></i>
                </button>
            </div>

            <!-- 下半部分：视图切换 -->
            <div class="view-switcher">
                <button id="btn-view-diary" onclick="journalManager.switchView('diary')" class="switch-item active">
                    Diary
                </button>
                <button id="btn-view-memory" onclick="journalManager.switchView('memory')" class="switch-item">
                    Memory
                </button>
            </div>
        </header>

        <!-- 装饰线 -->
        <div class="decorative-line"></div>

        <!-- === 2. 内容滚动区域 === -->
        <div class="journal-scroll-area">
            
            <!-- 视图 A: 日记本 -->
<div id="view-diary" class="view-section active-section relative">
    
    <!-- 1. 标题 -->
    <h1 id="noir-title" class="diary-title">Loading...</h1>
    
    <!-- 2. 新增：元数据行 (天气 & 心情) -->
    <div class="journal-meta-row">
        <!-- 天气胶囊 -->
        <div class="meta-chip weather-chip">
            <i id="meta-weather-icon" class="ph ph-cloud-moon"></i>
            <span id="meta-weather-text">Unknown</span>
        </div>
        <!-- 装饰竖线 -->
        <div class="w-[1px] h-3 bg-[#333]"></div>
        <!-- 心情胶囊 -->
        <div class="meta-chip mood-chip">
            <i class="ph ph-heartbeat animate-pulse"></i>
            <span id="meta-mood-text">Calm</span>
        </div>
    </div>

    <!-- 3. 正文 -->
    <div id="noir-body" class="diary-text mt-6"></div>

    <!-- 4. 底部功能区 (保持不变) -->
    <div class="footer-actions">
        <div id="diary-actions-footer">
            <button id="refresh-diary-btn" onclick="journalManager.handleDiaryRefresh()" class="refresh-btn">
                <i class="ph ph-arrows-clockwise"></i>
                <span id="refresh-diary-text">REGENERATE DIARY</span>
            </button>
        </div>

        <div id="comment-section" class="comment-preview hidden">
            <div class="comment-header">Echoes (Comments)</div>
            <div id="comment-thread" class="space-y-4 mb-4"></div>
            <form id="comment-form" onsubmit="event.preventDefault(); journalManager.submitComment();" class="relative">
                <input type="text" id="comment-textarea" class="comment-input" placeholder="Write a reply to him..." required>
                <button id="comment-submit-btn" type="submit" class="absolute right-0 bottom-2 text-[#D4AF37] text-xs">SEND</button>
            </form>
        </div>
    </div>
    
    <!-- 5. 新增：巨大的背景氛围图标  -->
    <i id="noir-bg-icon" class="ph ph-cloud-rain absolute -right-6 bottom-20 text-[12rem] text-[#111] pointer-events-none z-[-1] opacity-60"></i>
</div>

            <!-- 视图 B: 记忆核心 -->
            <div id="view-memory" class="view-section hidden-section">
                <div class="flex items-center justify-between mb-6">
                    <div class="text-[10px] tracking-[0.2em] text-[#D4AF37] font-bold">LONG-TERM CORE</div>
                    <div class="flex gap-2">
                         <button onclick="journalManager.toggleMemoryEdit()" class="text-xs text-gray-500 hover:text-white"><i class="ph ph-pencil-simple"></i> EDIT</button>
                         <button onclick="aiEngine.forceSummarize()" class="text-xs text-[#D4AF37] border border-[#D4AF37]/30 px-2 py-1">COMPRESS</button>
                    </div>
                </div>
                <div id="memory-timeline-view" class="space-y-6 pb-12"></div>
                <textarea id="char-memory" class="w-full h-[60vh] bg-[#080808] text-gray-400 font-mono text-xs p-4 border-none outline-none resize-none hidden"></textarea>
                <div class="mt-4 flex justify-between text-[9px] text-gray-600 border-t border-white/5 pt-2">
                    <span>THRESHOLD: <input type="number" id="memory-threshold" value="20" class="bg-transparent text-center w-8 text-white"></span>
                    <span id="mem-usage-display">0 chars</span>
                </div>
            </div>

        </div>
    </div>

    <!-- 日历弹窗保持原样 -->
    <div id="calendar-modal" class="absolute inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none invisible" onclick="journalManager.hideCalendar()">
        <div class="calendar-container" onclick="event.stopPropagation()">
            <div class="calendar-header">
                <button onclick="journalManager.changeMonth(-1)" class="calendar-nav-arrow"><i class="ph ph-caret-left"></i></button>
                <span id="calendar-month-display" class="month-display-text">NOV 2025</span>
                <button onclick="journalManager.changeMonth(1)" class="calendar-nav-arrow"><i class="ph ph-caret-right"></i></button>
            </div>
            <div class="calendar-grid">
                <div class="weekday">日</div><div class="weekday">一</div><div class="weekday">二</div><div class="weekday">三</div><div class="weekday">四</div><div class="weekday">五</div><div class="weekday">六</div>
            </div>
            <div class="calendar-legend">
                <div class="legend-item"><span class="legend-dot dot-diary"></span> 日记</div>
                <div class="legend-item"><span class="legend-dot dot-memory"></span> 记忆</div>
            </div>
        </div>
    </div>
</div>

    
    <script src="script.js"></script>

    <!-- 侧边功能坞 -->
    <div id="dock-panel" onclick="dockManager.close()">
        <div class="dock-content" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <span class="text-[#D4AF37] text-xs tracking-[0.2em] font-serif italic">MODULES</span>
                <button onclick="dockManager.close()" class="text-gray-500 hover:text-white"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div id="dock-home" class="app-grid">
                <div class="app-icon" onclick="memoManager.open()">
                    <div class="app-icon-box"><i class="ph ph-notebook"></i></div>
                    <span class="app-name">备忘录</span>
                </div>
                <!--日记本 -->
                <div class="app-icon" onclick="journalManager.open()">
                    <div class="app-icon-box"><i class="ph ph-book-bookmark"></i></div>
                    <span class="app-name">日记</span>
                </div>             
                <div class="app-icon" style="opacity:0.3; cursor:default">
                    <div class="app-icon-box border-dashed border-gray-700"><i class="ph ph-device-mobile"></i></div>
                    <span class="app-name">WIP</span>
                </div>
            </div>

<div id="app-memo" class="app-window hidden">
    <!-- 1. 顶部导航 -->
    <div class="memo-app-header">
        <button onclick="dockManager.showHome()" class="memo-back-btn"><i class="ph ph-caret-left"></i></button>
        <h2 class="memo-app-title">备忘录</h2>
        <button onclick="memoManager.showModal()" class="memo-add-btn" title="新增备忘"><i class="ph ph-plus"></i></button>
    </div>

    <!-- 2. 搜索与筛选 -->
    <div class="memo-controls">
        <div class="search-bar">
            <i class="ph ph-magnifying-glass"></i>
            <input type="text" id="memo-search-input" oninput="memoManager.render()" class="search-input" placeholder="搜索备忘录...">
        </div>
        <div id="memo-filter-chips" class="filter-chips">
        </div>
    </div>

    <!-- 3. 备忘录列表容器 -->
    <div id="memo-container" class="memo-list scrollbar-hide">
    </div>
</div>
        </div>
    </div>

    <!-- 顶部通知 Toast -->
    <div id="toast-notification">
        <i class="ph ph-pen-nib toast-icon"></i>
        <span id="toast-msg" class="toast-text">记录已更新</span>
    </div>

<div id="memo-modal-overlay" class="memo-modal-overlay hidden">
    <div class="memo-modal-content">
        <div class="memo-modal-header">
            <h3 id="memo-modal-title">新增备忘</h3>
            <button onclick="memoManager.hideModal()" class="close-modal-btn">&times;</button>
        </div>

        <form onsubmit="event.preventDefault(); memoManager.saveMemo();">
            <!-- 隐藏域，用于存储正在编辑的备忘录ID -->
            <input type="hidden" id="memo-edit-id">

            <div class="form-group">
                <label for="memo-topic-select">分类 (TOPIC)</label>
                <select id="memo-topic-select" class="form-select">
                    <!-- JS会在这里生成选项 -->
                </select>
            </div>

            <div class="form-group">
                <label for="memo-content-textarea">内容 (CONTENT)</label>
                <textarea id="memo-content-textarea" class="form-textarea" placeholder="记录下重要的事..." required></textarea>
            </div>

            <div class="form-actions">
                <button type="button" onclick="memoManager.hideModal()" class="action-btn btn-secondary">取消</button>
                <button type="submit" class="action-btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>
</body>
</html>